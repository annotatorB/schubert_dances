

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libs.sheet &mdash; Schubert Dances 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Schubert Dances
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libs.html">libs package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Schubert Dances</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libs.sheet</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libs.sheet</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Our custom-format, simplified sheet music class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">fractions</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># ---------------------------------------------------------------------------- #</span>
<span class="c1"># Sheet music and section storage classes</span>

<div class="viewcode-block" id="Sheet"><a class="viewcode-back" href="../../libs.html#libs.sheet.Sheet">[docs]</a><span class="k">class</span> <span class="nc">Sheet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Sheet music storage class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sections : :obj:`list` of :obj:`pandas.DataFrame`</span>
<span class="sd">        List of sections in played order, each possibly appearing several times.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Compared to a standard music sheet:</span>

<span class="sd">    - repetitions of (contiguous) sections are specified separately.</span>
<span class="sd">    - many informative elements (like ties between notes) are optionally stored.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    sheet.Section : section storage class.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    These examples illustrate how to build a sheet with repetitions of sections.</span>
<span class="sd">    Once the sheet and sections are built, it is then:</span>

<span class="sd">    - easy to playback a sheet, by just iterating over the stored sections.</span>
<span class="sd">    - possible to iterate over the sections as they (plausibly) were on paper, e.g.:</span>

<span class="sd">        - A B B C D E D E F =&gt; A ùÑÜ B ùÑá C ùÑÜ D E ùÑá F</span>
<span class="sd">        - A B C B D E       =&gt; A ùÑÜ B C¬π ùÑá D¬≤ E</span>
<span class="sd">        - A B C A D E A C F =&gt; ùÑÜ A B¬π C¬π¬≥ D¬≤ E¬≤ ùÑá F¬≥</span>

<span class="sd">    &gt;&gt;&gt; # Make a new sheet</span>
<span class="sd">    &gt;&gt;&gt; my_sheet = sheet.Sheet()</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Make three sections</span>
<span class="sd">    &gt;&gt;&gt; A, B, C = (sheet.Section() for _ in range(3))</span>
<span class="sd">    &gt;&gt;&gt; # Parse and fill the columns of the sections (see &#39;help(sheet.Section)&#39; for the format)</span>
<span class="sd">    &gt;&gt;&gt; # ...</span>
<span class="sd">    &gt;&gt;&gt; # Optional validity asserts each section once they have been fully built</span>
<span class="sd">    &gt;&gt;&gt; for section in (A, B, C):</span>
<span class="sd">    ...     section.assert_format()</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; # Make the repetition A-B-A-C-C</span>
<span class="sd">    &gt;&gt;&gt; for section in (A, B, A, C, C):</span>
<span class="sd">    ...     my_sheet.append(section)</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Iterate over the sections in playing order (i.e.: A-B-A-C-C)</span>
<span class="sd">    &gt;&gt;&gt; for section in my_sheet.as_played():</span>
<span class="sd">    ...     pass</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; # Iterate over the sections in (plausible) written order</span>
<span class="sd">    &gt;&gt;&gt; for section, (voltas, rep_begin, rep_end) in my_sheet.as_written():</span>
<span class="sd">    ...     # As the structure is (ùÑÜ A B¬π ùÑáùÑÜ C¬≤ ùÑá), the loop will iterate over:</span>
<span class="sd">    ...     # - A, ([], True, False)</span>
<span class="sd">    ...     # - B, ([1], False, True)</span>
<span class="sd">    ...     # - C, ([-2], True, True)  &lt;- volta value from previous pair of repetition bars is noted as negative (if any)</span>
<span class="sd">    ...     pass</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Save and load again the sheet</span>
<span class="sd">    &gt;&gt;&gt; sheet.save(my_sheet, &quot;my_sheet.sht&quot;)</span>
<span class="sd">    &gt;&gt;&gt; my_sheet = sheet.load(&quot;my_sheet.sht&quot;)</span>
<span class="sd">    &gt;&gt;&gt; my_sheet.assert_format()  # Optional, checks both the sheet and its sections</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize an empty sheet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<div class="viewcode-block" id="Sheet.append"><a class="viewcode-back" href="../../libs.html#libs.sheet.Sheet.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Append/repeat a section into the sheet.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        section : :obj:`sheet.Section`</span>
<span class="sd">            Section to append to the sheet.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Section</span>
<span class="sd">            The section passed as parameter, untouched</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Append section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="c1"># Return passed section</span>
        <span class="k">return</span> <span class="n">section</span></div>

<div class="viewcode-block" id="Sheet.as_played"><a class="viewcode-back" href="../../libs.html#libs.sheet.Sheet.as_played">[docs]</a>    <span class="k">def</span> <span class="nf">as_played</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list over the sections in played order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of Section</span>
<span class="sd">            List over the sections in played order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The behavior is undefined if the sheet is modified while using the returned value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span></div>

<div class="viewcode-block" id="Sheet.as_written"><a class="viewcode-back" href="../../libs.html#libs.sheet.Sheet.as_written">[docs]</a>    <span class="k">def</span> <span class="nf">as_written</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make a list over the sections in written order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of tuple of (Section, tuple of (list of int, bool, bool))</span>
<span class="sd">            List over the sections in written order, with additional information.</span>
<span class="sd">            The additional tuple of information contains:</span>
<span class="sd">            - The list of voltas (positive integers) of the section</span>
<span class="sd">            - Whether the section is preceeded by a &quot;begin&quot; repetition bar</span>
<span class="sd">            - Whether the section is followed by an &quot;end&quot; repetition bar</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            When the notation to achieve the existing repetition is unknown.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The behavior is undefined if the sheet is modified while using the returned value.</span>

<span class="sd">        A (probably not representable) sheet with reordered sections in a repetition (e.g. ABCACB)</span>
<span class="sd">        will not raise an error and be consistently output as in the first repetition (e.g. ùÑÜ ABC ùÑá).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Recover the position of each section instance, in first seen order</span>
        <span class="n">poses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># Cannot be a &#39;dict&#39; as a DataFrame is not hashable</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">):</span>
            <span class="c1"># Make or get list of positions for the current section</span>
            <span class="k">for</span> <span class="n">sec</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sec</span> <span class="ow">is</span> <span class="n">section</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">poses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">section</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
            <span class="c1"># Update the list of positions for the current section</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Build the result list from the position of each section instance</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Current controling repeat position block, if any</span>
        <span class="n">lvolta</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Last volta value from previous repetition</span>
        <span class="k">def</span> <span class="nf">consume_lvolta</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">lvolta</span>
            <span class="n">volta</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="k">if</span> <span class="n">lvolta</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="n">lvolta</span><span class="p">]</span>
            <span class="n">lvolta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">volta</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">poses</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">repeat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Outside any repetition</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span> <span class="c1"># Has repetition(s) with at least one other section</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span> <span class="p">(</span><span class="n">consume_lvolta</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="n">lvolta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># No other section involved</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span> <span class="p">(</span><span class="n">consume_lvolta</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span> <span class="p">(</span><span class="n">consume_lvolta</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unable to write more than two repetitions using the same section&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Inside a repetition</span>
                <span class="c1"># Solve the number of time the section appears per volta</span>
                <span class="n">seens</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">repeat</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">seens</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">volta</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">repeat</span><span class="p">[</span><span class="n">volta</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">volta</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">repeat</span><span class="p">)))]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Solve the voltas for this section</span>
                <span class="n">voltas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">seens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># If sometimes not repeated</span>
                    <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seens</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">seens</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">voltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># +1 simply because a volta starts counting at 1</span>
                        <span class="k">elif</span> <span class="n">seens</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unable to write section such that it is repeated more than once from inside a single repetition&quot;</span><span class="p">)</span>
                <span class="c1"># Emit the section</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">is_last</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poses</span><span class="p">)</span> <span class="k">else</span> <span class="n">poses</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">repeat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Next section starts after the last repeated position</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span> <span class="p">(</span><span class="n">voltas</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">is_last</span><span class="p">:</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Return the generated list</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Sheet.assert_format"><a class="viewcode-back" href="../../libs.html#libs.sheet.Sheet.assert_format">[docs]</a>    <span class="k">def</span> <span class="nf">assert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assert that this instance follows the specified format.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the format is not followed, with an explanatory error message.</span>
<span class="sd">            This is raised even when not in debug mode (i.e. `__debug__ == False`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">Section</span>
        <span class="c1"># Assert section is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;member &#39;sections&#39; is not a list, it is a </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">)</span>
        <span class="c1"># Assert each section</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">Section</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;section </span><span class="si">%d</span><span class="s2"> in member &#39;sections&#39; is not a Section, it is a </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">))</span>
            <span class="n">section</span><span class="o">.</span><span class="n">assert_format</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="Section"><a class="viewcode-back" href="../../libs.html#libs.sheet.Section">[docs]</a><span class="k">class</span> <span class="nc">Section</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Section of notes storage class.</span>

<span class="sd">    It is to be though as &quot;the ink on the paper&quot; for a continuous segment of notes,</span>
<span class="sd">    and absolutely not as a period; finding periods is left to subsequent analysis.</span>

<span class="sd">    The main purpose of a section is to hold notes, in attribute `notes` (a :obj:`pandas.DataFrame`).</span>

<span class="sd">    Mandatory columns:</span>

<span class="sd">    - note (:obj:`int`)</span>
<span class="sd">        Our augmented version of the circle-of-fifths notation for the note.</span>
<span class="sd">        See `libs/notes.py` for more details on this notation.</span>
<span class="sd">    - start (:obj:`fractions.Fraction`)</span>
<span class="sd">        Non-negative start time point (in beats), relative to the beginning of the section.</span>
<span class="sd">    - duration (:obj:`fractions.Fraction`)</span>
<span class="sd">        Positive duration (in beats).</span>

<span class="sd">    Optional columns:</span>

<span class="sd">    - velocity (:obj:`int` in [1 .. 127])</span>
<span class="sd">        Velocity at which the note must be played.</span>
<span class="sd">    - hand (:obj:`int`)</span>
<span class="sd">        Which hand (or more generally which voice) is supposed to play this note.</span>
<span class="sd">        (To be formalized, probably something like: 0 for unknown, -1 for left, 1 for right.)</span>

<span class="sd">    A section is augmented with metadata, and there is three mandatory metadata:</span>

<span class="sd">    - signature (tuple of two positive :obj:`int`)</span>
<span class="sd">        The time signature of this section.</span>
<span class="sd">    - silence (:obj:`fractions.Fraction`)</span>
<span class="sd">        A non-negative silence duration to play at the end of the section.</span>
<span class="sd">    - tempo (:obj:`float`)</span>
<span class="sd">        The tempo (in beats per minute) at which this section should be played.</span>

<span class="sd">    Additional metadata can be freely stored in the instance, as a new attribute.</span>
<span class="sd">    For instance, whether the section begins with a double bar can be specified this way.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Below we display the full internal structure of the Fr√®re Jacques nursery rhyme,</span>
<span class="sd">    which can be obtained with `python3 playground/frere_jacques.py &gt; frere_jacques.sht`</span>

<span class="sd">    &gt;&gt;&gt; # Import and load the sheet</span>
<span class="sd">    &gt;&gt;&gt; from libs import sheet</span>
<span class="sd">    &gt;&gt;&gt; my_sheet = sheet.load(&quot;frere_jacques.sht&quot;)</span>

<span class="sd">    &gt;&gt;&gt; # A sheet contains a single data member, named &#39;sections&#39;, which is a list of sections</span>
<span class="sd">    &gt;&gt;&gt; # The section instances are stored in playing order, so each can appear several times</span>
<span class="sd">    &gt;&gt;&gt; my_sheet.sections</span>
<span class="sd">    [&lt;libs.sheet.Section object at 0x7fdd5c24b9b0&gt;, ...]</span>

<span class="sd">    &gt;&gt;&gt; # Let&#39;s look (exhaustively) into the internal structure of the first section</span>
<span class="sd">    &gt;&gt;&gt; sec_0 = my_sheet.sections[0]</span>
<span class="sd">    &gt;&gt;&gt; # It contains 4 members: the &#39;notes&#39; dataframe, and 3 attributes.</span>
<span class="sd">    &gt;&gt;&gt; sec_0.signature  # The time signature for this section</span>
<span class="sd">    (2, 4)</span>
<span class="sd">    &gt;&gt;&gt; sec_0.silence    # A non-negative silence duration to play at the end of the section</span>
<span class="sd">    Fraction(0, 1)</span>
<span class="sd">    &gt;&gt;&gt; sec_0.tempo      # The tempo (in beats per minute) for this section</span>
<span class="sd">    60</span>
<span class="sd">    &gt;&gt;&gt; sec_0.notes      # The notes dataframe (see above for the structure)</span>
<span class="sd">       note start duration</span>
<span class="sd">    0   104     0      1/4</span>
<span class="sd">    1   106   1/4      1/4</span>
<span class="sd">    2   108   1/2      1/4</span>
<span class="sd">    3   104   3/4      1/4</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    sheet.Sheet : sheet music storage class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">silence</span><span class="o">=</span><span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tempo</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Section constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        signature : tuple of two positive int, optional</span>
<span class="sd">            Time signature of the section.</span>
<span class="sd">        silence : :obj:`fractions.Fraction`, optional</span>
<span class="sd">            Non-negative silence duration to play at the very end of the section.</span>
<span class="sd">        tempo : int or float, optional</span>
<span class="sd">            Positive tempo (in beats per minute) at which this section should be played.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Keyword arguments forwarded to the parent constructor.</span>
<span class="sd">            Notes:</span>
<span class="sd">            ¬∑ If the `columns` keyword argument is passed (expected a list),</span>
<span class="sd">              the given values are appended to the list of mandatory columns.</span>
<span class="sd">            ¬∑ If the `data` keyword argument is passed,</span>
<span class="sd">              no `columns` argument is forwarded by default and no check is made.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize the dataframe</span>
        <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Set the metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span>   <span class="o">=</span> <span class="n">silence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempo</span>     <span class="o">=</span> <span class="n">tempo</span>

<div class="viewcode-block" id="Section.assert_format"><a class="viewcode-back" href="../../libs.html#libs.sheet.Section.assert_format">[docs]</a>    <span class="k">def</span> <span class="nf">assert_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assert that this instance follows the specified format.</span>

<span class="sd">        Optional columns are not checked.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the format is not followed, with an explanatory error message.</span>
<span class="sd">            This is raised even when not in debug mode (i.e. `__debug__ == False`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># (Known) metadata assertions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;invalid time signature, expected a tuple of two positive int, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">,</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;invalid silence duration, expected a non-negative fraction, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempo</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempo</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;invalid tempo value, expected a positive number, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempo</span><span class="p">,))</span>
        <span class="c1"># Tuple of mandatory columns, with their respective type or value checker</span>
        <span class="n">mandatories</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># Tuple of optional columns, with their respective type/type checker</span>
        <span class="n">optionals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;hand&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># Assert that every mandatory column is here and with expected data type/values</span>
        <span class="k">for</span> <span class="n">columns</span><span class="p">,</span> <span class="n">mandatory</span> <span class="ow">in</span> <span class="p">((</span><span class="n">mandatories</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">optionals</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Assert existence</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mandatory</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;missing mandatory column </span><span class="si">%r</span><span class="s2"> in section&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Assert data type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                    <span class="n">checker</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">checker</span> <span class="o">=</span> <span class="n">dtype</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">checker</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;some row(s) for </span><span class="si">%s</span><span class="s2"> column </span><span class="si">%r</span><span class="s2"> do(es) not have a valid type/value&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="s2">&quot;mandatory&quot;</span> <span class="k">if</span> <span class="n">mandatory</span> <span class="k">else</span> <span class="s2">&quot;optional&quot;</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
        <span class="c1"># Check that the note start timestamps are monotonically increasing, starting no before than 0</span>
        <span class="n">clock</span> <span class="o">=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;note start timestamps are not monotonically increasing or start before clock 0&quot;</span><span class="p">)</span>
            <span class="n">clock</span> <span class="o">=</span> <span class="n">start</span></div></div>

<span class="c1"># ---------------------------------------------------------------------------- #</span>
<span class="c1"># Load and save sheets</span>

<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../libs.html#libs.sheet.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load a sheet from a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path (or equivalent)</span>
<span class="sd">        Path to the file to load from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sheet</span>
<span class="sd">        Loaded sheet instance.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fix_imports</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">,</span> <span class="n">fix_imports</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../libs.html#libs.sheet.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">path_or_fd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Save a sheet to a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sheet : :obj:`sheet.Sheet`</span>
<span class="sd">        Instance of the sheet to save.</span>
<span class="sd">    path_or_fd : str or pathlib.PurePath, or io.BytesIO (or equivalent)</span>
<span class="sd">        Path to the file to save to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_or_fd</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">,</span> <span class="n">fix_imports</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">path_or_fd</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">,</span> <span class="n">fix_imports</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, TeamSchubert

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>